<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Zone Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@700&display=swap');
        
        :root {
            --bg-dark: #0f172a;
            --card-dark: #1e293b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #f8fafc;
        }

        .timer-font {
            font-family: 'JetBrains Mono', monospace;
        }

        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-list::-webkit-scrollbar {
            width: 6px;
        }
        .history-list::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div id="app" class="max-w-4xl mx-auto space-y-8">
        <!-- HEADER -->
        <header class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">Focus Zone</h1>
                <p class="text-slate-400" id="user-display">Initializing session...</p>
            </div>
            <div id="status-badge" class="px-4 py-2 rounded-full bg-blue-500/10 text-blue-400 border border-blue-500/20 text-sm font-semibold">
                IDLE
            </div>
        </header>

        <!-- DASHBOARD GRID -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- LEFT COLUMN: THE TIMER (Main Focus) -->
            <div class="lg:col-span-7 flex flex-col items-center justify-center glass-card p-10 rounded-3xl shadow-2xl relative overflow-hidden">
                <!-- Background Accent -->
                <div class="absolute -top-24 -right-24 w-48 h-48 bg-blue-600/10 rounded-full blur-3xl"></div>
                
                <!-- Circular Timer -->
                <div class="relative w-72 h-72 md:w-80 md:h-80 flex items-center justify-center mb-8">
                    <svg class="w-full h-full">
                        <circle class="text-slate-800" stroke-width="8" stroke="currentColor" fill="transparent" r="150" cx="160" cy="160" style="r: 45%; cx: 50%; cy: 50%;"/>
                        <circle id="progress-circle" class="text-blue-500 progress-ring__circle" stroke-width="8" stroke-dasharray="1000" stroke-dashoffset="1000" stroke-linecap="round" stroke="currentColor" fill="transparent" r="150" cx="160" cy="160" style="r: 45%; cx: 50%; cy: 50%;"/>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <div id="timer-display" class="text-6xl md:text-7xl font-bold timer-font tracking-tighter">25:00</div>
                        <div id="mode-label" class="text-slate-500 font-medium uppercase tracking-widest text-xs mt-2">Focus Mode</div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex items-center gap-6 z-10">
                    <button id="reset-btn" class="w-14 h-14 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center transition-all">
                        <i class="fa-solid fa-rotate-left text-xl"></i>
                    </button>
                    
                    <button id="main-btn" class="w-20 h-20 rounded-full bg-blue-600 hover:bg-blue-500 flex items-center justify-center shadow-lg shadow-blue-900/40 transition-all hover:scale-105 active:scale-95">
                        <i id="main-icon" class="fa-solid fa-play text-3xl"></i>
                    </button>

                    <button id="skip-btn" class="w-14 h-14 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center transition-all">
                        <i class="fa-solid fa-forward text-xl"></i>
                    </button>
                </div>

                <!-- Mode Selection -->
                <div class="flex gap-3 mt-10">
                    <button data-time="25" data-mode="focus" class="mode-btn px-6 py-2 rounded-full text-sm font-semibold transition-all bg-blue-600 text-white">Focus</button>
                    <button data-time="5" data-mode="break" class="mode-btn px-6 py-2 rounded-full text-sm font-semibold transition-all bg-slate-800 text-slate-400">Short Break</button>
                    <button data-time="15" data-mode="break" class="mode-btn px-6 py-2 rounded-full text-sm font-semibold transition-all bg-slate-800 text-slate-400">Long Break</button>
                </div>
            </div>

            <!-- RIGHT COLUMN: HISTORY & STATS -->
            <div class="lg:col-span-5 flex flex-col gap-6">
                <!-- Stats Row -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-card p-6 rounded-2xl">
                        <p class="text-slate-400 text-xs font-bold uppercase mb-1">Total Focus</p>
                        <div id="total-time-stat" class="text-2xl font-bold">0m</div>
                    </div>
                    <div class="glass-card p-6 rounded-2xl">
                        <p class="text-slate-400 text-xs font-bold uppercase mb-1">Sessions</p>
                        <div id="session-count-stat" class="text-2xl font-bold">0</div>
                    </div>
                </div>

                <!-- History Log -->
                <div class="glass-card flex-1 rounded-2xl flex flex-col overflow-hidden min-h-[400px]">
                    <div class="p-6 border-b border-slate-700/50 flex justify-between items-center">
                        <h3 class="font-bold flex items-center gap-2">
                            <i class="fa-solid fa-clock-rotate-left text-blue-400"></i>
                            Recent History
                        </h3>
                    </div>
                    <div id="history-container" class="flex-1 overflow-y-auto history-list p-4 space-y-3">
                        <div class="text-center py-10 text-slate-500 italic text-sm">
                            No sessions recorded yet. Start focusing!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl bg-green-600 text-white font-bold shadow-2xl opacity-0 pointer-events-none transition-all transform translate-y-4">
        Session Saved! ðŸš€
    </div>

    <!-- Firebase Configuration & Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Setup ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'focus-zone-demo';

        // --- App State ---
        let timerInterval = null;
        let isRunning = false;
        let timeLeft = 25 * 60;
        let currentModeTime = 25 * 60;
        let currentMode = 'focus';
        let currentUser = null;

        // --- UI Elements ---
        const timerDisplay = document.getElementById('timer-display');
        const mainBtn = document.getElementById('main-btn');
        const mainIcon = document.getElementById('main-icon');
        const resetBtn = document.getElementById('reset-btn');
        const skipBtn = document.getElementById('skip-btn');
        const modeLabel = document.getElementById('mode-label');
        const statusBadge = document.getElementById('status-badge');
        const progressCircle = document.getElementById('progress-circle');
        const historyContainer = document.getElementById('history-container');
        const totalTimeStat = document.getElementById('total-time-stat');
        const sessionCountStat = document.getElementById('session-count-stat');
        const userDisplay = document.getElementById('user-display');
        const toast = document.getElementById('toast');

        const RADIUS = 150 * 0.45; // Using relative calc from SVG
        const CIRCUMFERENCE = 2 * Math.PI * 144; // Approx based on 45% of 320px

        // --- Core Functions ---

        function updateDisplay() {
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            timerDisplay.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            // Update Circle
            const offset = CIRCUMFERENCE - (timeLeft / currentModeTime) * CIRCUMFERENCE;
            progressCircle.style.strokeDashoffset = offset;
            progressCircle.style.strokeDasharray = CIRCUMFERENCE;
        }

        async function saveSession() {
            if (!currentUser) return;
            
            const durationMinutes = Math.floor(currentModeTime / 60);
            
            try {
                const sessionsCol = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'focus_sessions');
                await addDoc(sessionsCol, {
                    type: currentMode,
                    duration: durationMinutes,
                    timestamp: serverTimestamp(),
                    label: currentMode === 'focus' ? 'Deep Work' : 'Rest Break'
                });
                showToast(`Saved ${durationMinutes}m ${currentMode} session!`);
            } catch (err) {
                console.error("Error saving session:", err);
            }
        }

        function toggleTimer() {
            if (isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            if (isRunning) return;
            isRunning = true;
            mainIcon.className = "fa-solid fa-pause text-3xl";
            statusBadge.textContent = "ACTIVE";
            statusBadge.className = "px-4 py-2 rounded-full bg-green-500/10 text-green-400 border border-green-500/20 text-sm font-semibold";
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateDisplay();
                
                if (timeLeft <= 0) {
                    completeSession();
                }
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            mainIcon.className = "fa-solid fa-play text-3xl text-white ml-1";
            statusBadge.textContent = "PAUSED";
            statusBadge.className = "px-4 py-2 rounded-full bg-yellow-500/10 text-yellow-400 border border-yellow-500/20 text-sm font-semibold";
        }

        function resetTimer() {
            pauseTimer();
            timeLeft = currentModeTime;
            updateDisplay();
        }

        async function completeSession() {
            pauseTimer();
            await saveSession();
            resetTimer();
            // Optional: Trigger a sound notification
            try { new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play(); } catch(e){}
        }

        function setMode(mins, mode) {
            pauseTimer();
            currentMode = mode;
            currentModeTime = mins * 60;
            timeLeft = currentModeTime;
            modeLabel.textContent = mode === 'focus' ? 'Focus Mode' : 'Break Mode';
            
            // Update buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                const isActive = parseInt(btn.dataset.time) === mins && btn.dataset.mode === mode;
                btn.className = isActive 
                    ? `mode-btn px-6 py-2 rounded-full text-sm font-semibold transition-all ${mode === 'focus' ? 'bg-blue-600' : 'bg-green-600'} text-white`
                    : "mode-btn px-6 py-2 rounded-full text-sm font-semibold transition-all bg-slate-800 text-slate-400";
            });

            progressCircle.className = `progress-ring__circle ${mode === 'focus' ? 'text-blue-500' : 'text-green-500'}`;
            updateDisplay();
        }

        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.remove('opacity-0', 'translate-y-4');
            toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-4');
                toast.classList.remove('opacity-100', 'translate-y-0');
            }, 3000);
        }

        // --- Data Listener ---
        function setupDataListeners(user) {
            const sessionsCol = collection(db, 'artifacts', appId, 'users', user.uid, 'focus_sessions');
            
            // We fetch all and sort in memory as per Rule 2
            onSnapshot(sessionsCol, (snapshot) => {
                const sessions = [];
                snapshot.forEach(doc => {
                    sessions.push({ id: doc.id, ...doc.data() });
                });

                // Sort by timestamp descending
                sessions.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                renderHistory(sessions);
                updateStats(sessions);
            }, (err) => console.error("Firestore Error:", err));
        }

        function renderHistory(sessions) {
            if (sessions.length === 0) {
                historyContainer.innerHTML = `<div class="text-center py-10 text-slate-500 italic text-sm">No sessions recorded yet.</div>`;
                return;
            }

            historyContainer.innerHTML = sessions.map(s => {
                const date = s.timestamp ? new Date(s.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Just now';
                const isFocus = s.type === 'focus';
                return `
                    <div class="flex items-center justify-between p-3 bg-slate-800/40 rounded-xl border border-slate-700/30 fade-in">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg ${isFocus ? 'bg-blue-500/10 text-blue-400' : 'bg-green-500/10 text-green-400'} flex items-center justify-center">
                                <i class="fa-solid ${isFocus ? 'fa-brain' : 'fa-mug-hot'}"></i>
                            </div>
                            <div>
                                <div class="font-bold text-sm">${s.label || 'Session'}</div>
                                <div class="text-[10px] text-slate-500 uppercase tracking-wider">${date}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-mono text-sm font-bold">${s.duration}m</div>
                            <div class="text-[10px] text-slate-500">COMPLETED</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats(sessions) {
            const focusSessions = sessions.filter(s => s.type === 'focus');
            const totalMins = focusSessions.reduce((acc, s) => acc + (s.duration || 0), 0);
            
            totalTimeStat.textContent = totalMins > 60 
                ? `${Math.floor(totalMins/60)}h ${totalMins%60}m` 
                : `${totalMins}m`;
            sessionCountStat.textContent = focusSessions.length;
        }

        // --- Init ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth Error:", err);
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                userDisplay.textContent = `User: ${user.uid.substring(0, 8)}...`;
                setupDataListeners(user);
            }
        });

        // Event Listeners
        mainBtn.addEventListener('click', toggleTimer);
        resetBtn.addEventListener('click', resetTimer);
        skipBtn.addEventListener('click', () => {
            if (confirm("Skip this session? It won't be saved.")) {
                resetTimer();
            }
        });

        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const time = parseInt(btn.dataset.time);
                const mode = btn.dataset.mode;
                setMode(time, mode);
            });
        });

        // Start Up
        initAuth();
        updateDisplay();

    </script>
</body>
</html>